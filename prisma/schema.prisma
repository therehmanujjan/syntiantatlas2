generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Syntiant Atlas — Prisma Schema (introspected from production + cleaned up)
// =============================================================================

model Role {
  id           String    @id @db.VarChar(50)
  name         String    @db.VarChar(100)
  description  String?
  permissions  Json?     @default("[]")
  isSystemRole Boolean?  @default(false) @map("is_system_role")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@map("roles")
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique @db.VarChar(255)
  phone         String?   @db.VarChar(50)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  firstName     String?   @map("first_name") @db.VarChar(100)
  lastName      String?   @map("last_name") @db.VarChar(100)
  roleId        String?   @default("investor") @map("role_id") @db.VarChar(50)
  kycStatus     String?   @default("pending") @map("kyc_status") @db.VarChar(50)
  kycLevel      Int?      @default(1) @map("kyc_level")
  walletBalance Decimal?  @default(0.00) @map("wallet_balance") @db.Decimal(15, 2)
  status        String?   @default("active") @db.VarChar(50)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  auditLogs                                              AuditLog[]
  investments                                            Investment[]
  kycVerificationsAsReviewer                             KycVerification[] @relation("KycReviewer")
  kycVerifications                                       KycVerification[] @relation("KycUser")
  notifications                                          Notification[]
  properties                                             Property[]        @relation("SellerProperties")
  sessions                                               Session[]
  staffCredentialsAsCreator                              StaffCredential[] @relation("StaffCreator")
  staffCredentials                                       StaffCredential[] @relation("StaffUser")
  tasksAssignedBy                                        Task[]            @relation("TaskAssignedBy")
  tasksAssignedTo                                        Task[]            @relation("TaskAssignedTo")
  ticketReplies                                          TicketReply[]
  transactions                                           Transaction[]
  dividendPayments                                       DividendPayment[]
  marketplaceListings                                    MarketplaceListing[]  @relation("ListingSeller")
  marketplacePurchases                                   MarketplaceTrade[]    @relation("TradeBuyer")
  marketplaceSales                                       MarketplaceTrade[]    @relation("TradeSeller")
  paymentMethods                                         PaymentMethod[]
  governanceProposals                                    GovernanceProposal[]
  governanceVotes                                        GovernanceVote[]
  addresses                                              UserAddress[]
  bankAccounts                                           BankAccount[]
  contentProgress                                        ContentProgress[]

  @@index([email], map: "idx_users_email")
  @@index([roleId], map: "idx_users_role")
  @@map("users")
}

model Property {
  id                    Int       @id @default(autoincrement())
  sellerId              Int?      @map("seller_id")
  title                 String    @db.VarChar(255)
  description           String?
  location              String?   @db.VarChar(255)
  address               String?
  city                  String?   @db.VarChar(100)
  propertyType          String?   @map("property_type") @db.VarChar(50)
  areaSqft              Decimal?  @map("area_sqft") @db.Decimal(10, 2)
  totalValue            Decimal?  @map("total_value") @db.Decimal(15, 2)
  fundingTarget         Decimal?  @map("funding_target") @db.Decimal(15, 2)
  minInvestment         Decimal?  @map("min_investment") @db.Decimal(15, 2)
  maxInvestment         Decimal?  @map("max_investment") @db.Decimal(15, 2)
  expectedReturnsAnnual Decimal?  @map("expected_returns_annual") @db.Decimal(5, 2)
  rentalYield           Decimal?  @map("rental_yield") @db.Decimal(5, 2)
  status                String?   @default("active") @db.VarChar(50)
  fundingRaised         Decimal?  @default(0.00) @map("funding_raised") @db.Decimal(15, 2)
  createdAt             DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  dividends           Dividend[]
  dividendPayments    DividendPayment[]
  investments         Investment[]
  marketplaceListings MarketplaceListing[]
  marketplaceTrades   MarketplaceTrade[]
  governanceProposals GovernanceProposal[]
  seller              User?        @relation("SellerProperties", fields: [sellerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("properties")
}

model Investment {
  id                  Int       @id @default(autoincrement())
  investorId          Int?      @map("investor_id")
  propertyId          Int?      @map("property_id")
  amountInvested      Decimal   @map("amount_invested") @db.Decimal(15, 2)
  sharesOwned         Decimal?  @map("shares_owned") @db.Decimal(15, 4)
  ownershipPercentage Decimal?  @map("ownership_percentage") @db.Decimal(5, 4)
  investmentDate      DateTime? @default(now()) @map("investment_date") @db.Timestamp(6)

  // Relations
  investor User?     @relation(fields: [investorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("investments")
}

model Transaction {
  id              Int       @id @default(autoincrement())
  userId          Int?      @map("user_id")
  type            String    @db.VarChar(50)
  amount          Decimal   @db.Decimal(15, 2)
  gateway         String?   @db.VarChar(50)
  paymentMethod   String?   @map("payment_method") @db.VarChar(50)
  referenceNumber String?   @map("reference_number") @db.VarChar(100)
  description     String?
  status          String?   @default("completed") @db.VarChar(50)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("transactions")
}

model AuditLog {
  id         Int       @id @default(autoincrement())
  userId     Int?      @map("user_id")
  action     String    @db.VarChar(100)
  entityType String?   @map("entity_type") @db.VarChar(50)
  entityId   Int?      @map("entity_id")
  details    Json?     @default("{}")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("audit_logs")
}

model Dividend {
  id                    Int       @id @default(autoincrement())
  propertyId            Int?      @map("property_id")
  quarter               Int?
  year                  Int?
  totalRentalIncome     Decimal?  @map("total_rental_income") @db.Decimal(15, 2)
  totalExpenses         Decimal?  @map("total_expenses") @db.Decimal(15, 2)
  netIncome             Decimal?  @map("net_income") @db.Decimal(15, 2)
  distributionPerShare  Decimal?  @map("distribution_per_share") @db.Decimal(10, 4)
  distributionDate      DateTime? @default(dbgenerated("CURRENT_DATE")) @map("distribution_date") @db.Date

  // Relations
  property Property? @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payments DividendPayment[]

  @@unique([propertyId, quarter, year], map: "uq_dividend_property_quarter_year")
  @@map("dividends")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model KycVerification {
  id              Int       @id @default(autoincrement())
  userId          Int?      @map("user_id")
  kycLevel        Int?      @default(1) @map("kyc_level")
  documentType    String?   @map("document_type") @db.VarChar(100)
  documentData    Json?     @map("document_data")
  status          String?   @default("pending") @db.VarChar(50)
  reviewedBy      Int?      @map("reviewed_by")
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamp(6)
  rejectionReason String?   @map("rejection_reason")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  reviewer User? @relation("KycReviewer", fields: [reviewedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user     User? @relation("KycUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("kyc_verifications")
}

model Session {
  id              Int       @id @default(autoincrement())
  userId          Int?      @map("user_id")
  tokenHash       String    @map("token_hash") @db.VarChar(255)
  refreshTokenHash String?  @map("refresh_token_hash") @db.VarChar(255)
  deviceInfo      Json?     @map("device_info")
  ipAddress       String?   @map("ip_address") @db.VarChar(45)
  expiresAt       DateTime  @map("expires_at") @db.Timestamp(6)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  lastActivityAt  DateTime? @default(now()) @map("last_activity_at") @db.Timestamp(6)

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("sessions")
}

model StaffCredential {
  id               Int       @id @default(autoincrement())
  userId           Int?      @map("user_id")
  employeeId       String    @unique @map("employee_id") @db.VarChar(20)
  tempPasswordHash String?   @map("temp_password_hash") @db.VarChar(255)
  passwordChanged  Boolean?  @default(false) @map("password_changed")
  createdBy        Int?      @map("created_by")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  creator User? @relation("StaffCreator", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user    User? @relation("StaffUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("staff_credentials")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Task {
  id                Int       @id @default(autoincrement())
  title             String    @db.VarChar(255)
  description       String?
  assignedTo        Int?      @map("assigned_to")
  assignedBy        Int?      @map("assigned_by")
  priority          String?   @default("medium") @db.VarChar(20)
  status            String?   @default("pending") @db.VarChar(50)
  dueDate           DateTime? @map("due_date") @db.Timestamp(6)
  completedAt       DateTime? @map("completed_at") @db.Timestamp(6)
  relatedEntityType String?   @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   Int?      @map("related_entity_id")
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  // Relations
  assignedByUser User? @relation("TaskAssignedBy", fields: [assignedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignedToUser User? @relation("TaskAssignedTo", fields: [assignedTo], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        TicketReply[]

  @@map("tasks")
}

model TicketReply {
  id        Int       @id @default(autoincrement())
  taskId    Int       @map("task_id")
  userId    Int       @map("user_id")
  message   String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("ticket_replies")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  type      String    @db.VarChar(50)
  title     String    @db.VarChar(255)
  message   String
  data      Json?     @default("{}")
  isRead    Boolean   @default(false) @map("is_read")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId, isRead], map: "idx_notifications_user_read")
  @@map("notifications")
}

model SystemSetting {
  id          Int       @id @default(autoincrement())
  key         String    @unique @db.VarChar(100)
  value       String
  description String?
  category    String?   @db.VarChar(50)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@map("system_settings")
}

// =============================================================================
// Phase 6: Advanced Services — New Models
// =============================================================================

model DividendPayment {
  id           Int       @id @default(autoincrement())
  dividendId   Int       @map("dividend_id")
  investorId   Int       @map("investor_id")
  propertyId   Int       @map("property_id")
  sharesOwned  Decimal   @map("shares_owned") @db.Decimal(15, 4)
  amountPaid   Decimal   @map("amount_paid") @db.Decimal(15, 2)
  status       String    @default("completed") @db.VarChar(50)
  paidAt       DateTime? @default(now()) @map("paid_at") @db.Timestamp(6)

  // Relations
  dividend Dividend @relation(fields: [dividendId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  investor User     @relation(fields: [investorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  property Property @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([dividendId], map: "idx_dividend_payments_dividend")
  @@index([investorId], map: "idx_dividend_payments_investor")
  @@map("dividend_payments")
}

model MarketplaceListing {
  id            Int       @id @default(autoincrement())
  propertyId    Int       @map("property_id")
  sellerId      Int       @map("seller_id")
  sharesListed  Decimal   @map("shares_listed") @db.Decimal(15, 4)
  sharesRemaining Decimal @map("shares_remaining") @db.Decimal(15, 4)
  pricePerShare Decimal   @map("price_per_share") @db.Decimal(15, 2)
  status        String    @default("active") @db.VarChar(50) // active, sold, cancelled, expired
  expiresAt     DateTime? @map("expires_at") @db.Timestamp(6)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  property Property          @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  seller   User              @relation("ListingSeller", fields: [sellerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  trades   MarketplaceTrade[]

  @@index([propertyId, status], map: "idx_listings_property_status")
  @@index([sellerId], map: "idx_listings_seller")
  @@map("marketplace_listings")
}

model MarketplaceTrade {
  id            Int       @id @default(autoincrement())
  listingId     Int       @map("listing_id")
  propertyId    Int       @map("property_id")
  buyerId       Int       @map("buyer_id")
  sellerId      Int       @map("seller_id")
  sharesBought  Decimal   @map("shares_bought") @db.Decimal(15, 4)
  pricePerShare Decimal   @map("price_per_share") @db.Decimal(15, 2)
  totalPrice    Decimal   @map("total_price") @db.Decimal(15, 2)
  platformFee   Decimal   @default(0) @map("platform_fee") @db.Decimal(15, 2)
  status        String    @default("completed") @db.VarChar(50)
  executedAt    DateTime? @default(now()) @map("executed_at") @db.Timestamp(6)

  // Relations
  listing  MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  property Property           @relation(fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  buyer    User               @relation("TradeBuyer", fields: [buyerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  seller   User               @relation("TradeSeller", fields: [sellerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([listingId], map: "idx_trades_listing")
  @@index([buyerId], map: "idx_trades_buyer")
  @@index([sellerId], map: "idx_trades_seller")
  @@map("marketplace_trades")
}

model PaymentMethod {
  id               Int       @id @default(autoincrement())
  userId           Int       @map("user_id")
  type             String    @db.VarChar(50) // card, bank_account
  provider         String    @db.VarChar(50) // stripe
  externalId       String    @map("external_id") @db.VarChar(255) // Stripe payment method ID
  last4            String?   @db.VarChar(4)
  brand            String?   @db.VarChar(50) // visa, mastercard, etc.
  expiryMonth      Int?      @map("expiry_month")
  expiryYear       Int?      @map("expiry_year")
  isDefault        Boolean   @default(false) @map("is_default")
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_payment_methods_user")
  @@map("payment_methods")
}

// =============================================================================
// Phase 8: Governance
// =============================================================================

model GovernanceProposal {
  id              Int       @id @default(autoincrement())
  propertyId      Int       @map("property_id")
  proposerId      Int       @map("proposer_id")
  title           String    @db.VarChar(255)
  description     String
  status          String    @default("active") @db.VarChar(50) // active, passed, failed, executed, cancelled
  forVotes        Int       @default(0) @map("for_votes")
  againstVotes    Int       @default(0) @map("against_votes")
  quorum          Int       @default(100)
  votingEndsAt    DateTime  @map("voting_ends_at") @db.Timestamp(6)
  executedAt      DateTime? @map("executed_at") @db.Timestamp(6)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  proposer User     @relation(fields: [proposerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  votes    GovernanceVote[]

  @@index([propertyId], map: "idx_governance_proposals_property")
  @@index([proposerId], map: "idx_governance_proposals_proposer")
  @@index([status], map: "idx_governance_proposals_status")
  @@map("governance_proposals")
}

model GovernanceVote {
  id         Int       @id @default(autoincrement())
  proposalId Int       @map("proposal_id")
  voterId    Int       @map("voter_id")
  vote       String    @db.VarChar(20) // for, against
  weight     Int       @default(1)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  proposal GovernanceProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  voter    User               @relation(fields: [voterId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([proposalId, voterId], map: "uq_governance_vote_unique")
  @@index([voterId], map: "idx_governance_votes_voter")
  @@map("governance_votes")
}

// =============================================================================
// Phase 11: Settings — User Sub-resources
// =============================================================================

model UserAddress {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  street     String    @db.VarChar(255)
  city       String    @db.VarChar(100)
  state      String?   @db.VarChar(100)
  postalCode String?   @map("postal_code") @db.VarChar(20)
  country    String    @default("Pakistan") @db.VarChar(100)
  isDefault  Boolean   @default(false) @map("is_default")
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_user_addresses_user")
  @@map("user_addresses")
}

model BankAccount {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  bankName     String    @map("bank_name") @db.VarChar(100)
  accountTitle String    @map("account_title") @db.VarChar(255)
  iban         String    @db.VarChar(34)
  branchCode   String?   @map("branch_code") @db.VarChar(20)
  isDefault    Boolean   @default(false) @map("is_default")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_bank_accounts_user")
  @@map("bank_accounts")
}

// =============================================================================
// Phase 13: Content & Learning
// =============================================================================

model ContentItem {
  id            Int       @id @default(autoincrement())
  title         String    @db.VarChar(255)
  body          String
  excerpt       String?   @db.VarChar(500)
  type          String    @default("article") @db.VarChar(50) // article, video, infographic
  category      String    @db.VarChar(100) // getting_started, investment_basics, real_estate_101, dao_blockchain, market_insights, advanced_strategies
  difficulty    String    @default("beginner") @db.VarChar(50) // beginner, intermediate, advanced
  readTime      Int?      @map("read_time") // estimated reading time in minutes
  thumbnailUrl  String?   @map("thumbnail_url") @db.VarChar(500)
  videoUrl      String?   @map("video_url") @db.VarChar(500)
  tags          Json?     @default("[]") // array of tag strings
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamp(6)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  progress ContentProgress[]

  @@index([category], map: "idx_content_items_category")
  @@index([type], map: "idx_content_items_type")
  @@index([isPublished], map: "idx_content_items_published")
  @@map("content_items")
}

model ContentProgress {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  contentItemId Int       @map("content_item_id")
  completed     Boolean   @default(false)
  completedAt   DateTime? @map("completed_at") @db.Timestamp(6)
  lastAccessedAt DateTime? @default(now()) @map("last_accessed_at") @db.Timestamp(6)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, contentItemId], map: "uq_content_progress_user_item")
  @@index([userId], map: "idx_content_progress_user")
  @@map("content_progress")
}
